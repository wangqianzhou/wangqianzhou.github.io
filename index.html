<html>
<head>
  <meta charset="utf-8">
  <title>预加载頁面</title>
</head>

<body>
  <div id="id">这是测试页面</id>
</body>
<script>


  function getRegistration() {
    return new Promise(function(resolve, reject) {
      navigator.serviceWorker.getRegistration().then(function(existsReg){
        if (existsReg) {
          console.log("Exists Service Worker detected.");
          resolve(existsReg);
        } else {
          console.log("No Exists Service Worker detected.");
          navigator.serviceWorker.register('/act/sw.js', {scope:"/act/"}).then(function(newReg) {
            console.log("New Service Worker created.");
            resolve(newReg);
          }).catch(function(error){
            reject(error)
          })
        }
      });
    });
  }


  function waitUntilInstalled(registration) {
    return new Promise(function(resolve, reject) {
      if (registration.installing) {

        registration.installing.addEventListener('statechange', function(e) {
          if (e.target.state === 'installed') {
            resolve(registration);
          } else if(e.target.state === 'redundant') {
            reject(registration);
          }
        });
      } else {

        resolve(registration);
      }
    });
  }

  function waitUntilActivated(registration) {
    return navigator.serviceWorker.ready;
  }

  function syncIfNeeded(registration) {
    return new Promise(function(resolve, reject) {
      resolve(registration);

      if ('sync' in registration) {
        registration.sync.register('sync_cache').then(function() {
            console.log("Service Worker has finished sync_cache.");
          }, function(error) {
            console.log("Service Worker has failed sync_cache with error:" + error + ".");
          });
      }
    });
  }

  function notifyIfNeeded(registration) {
    return new Promise(function(resolve, reject) {
      if ('controller' in navigator.serviceWorker) {
        resolve(registration);

        if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({"command": "clear_cache"});
            navigator.serviceWorker.controller.postMessage({"command": "prefetch_cache"});
        }
      }
    });
  }

  function getSubscription(registration) {
    return new Promise(function(resolve, reject) {
      registration.pushManager.getSubscription().then(function(existsSubscription){
        if (existsSubscription) {
          console.log("Exists Subscription detected.");
          resolve(existsSubscription);
        } else {
          console.log("No Exists Subscription detected.");
          registration.pushManager.subscribe({userVisibleOnly: true}).then(function(newSubscription) {
            console.log("New Subscription created.");
            resolve(newSubscription);
          });
        }
      });
    });
  }

  function subscribeIfNeeded(registration) {
    return new Promise(function(resolve, reject) {
      resolve(registration);

      getSubscription(registration).then(function(subscription){
        console.log('getSubscription successful, scope:' + registration.scope + ', endpoint:', subscription.endpoint);
        updateSubscription(registration, subscription);
      });
    });
  }

  if ('serviceWorker' in navigator) {

    getRegistration()
    .then(waitUntilInstalled)
    .then(waitUntilActivated)
    .then(syncIfNeeded)
    .then(subscribeIfNeeded)
    .then(notifyIfNeeded)
    .catch(function(error) {
      console.log("Service worker failed in: ", error);
    });
  }
</script>
</html>
